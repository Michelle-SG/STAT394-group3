---
title: "Main Elements"
format: pdf
editor: visual
---

```{r}
library(ggplot2)
library(tidyverse)
library(corrplot)
library(GGally)
library(knitr)
library(ggbiplot)
```

```{r}
# Data setup
df <- read.csv("C:\\Users\\k4n3r\\iCloudDrive\\Desktop\\Max\\orichalcum_ingots_dataset.csv", skip = 2)
main.elements <- df[, 1:5]
colnames(main.elements) <- c("Sample", "Cu", "Zn", "Pb", "Fe")
head(main.elements)

main.elements.long <- main.elements %>%
  pivot_longer(!Sample, names_to = "Element", values_to = "Concentration")
```

```{r}
# Summary histograms
ggplot(main.elements.long, aes(x = Concentration)) +
  # Histogram
  geom_histogram(bins = nclass.FD(main.elements.long$Concentration),
                 fill = "skyblue", color = "white") +
  # Boxplot, anchored at y = -0.5 so it sits below
  geom_boxplot(aes(y = -0.5), notch = TRUE, box.color='orange', alpha = 0.7, width = 0.3, outlier.size = 1) +
  facet_wrap(~Element, scales = "free_x", ncol = 2) +
  theme_minimal() +
  labs(title = "Main Element histograms with boxplots",
       x = "Concentration",
       y = NULL) +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
  )


summary_table <- main.elements %>%
  select(-Sample) %>%
  pivot_longer(everything(), names_to = "Element", values_to = "Concentration") %>%
  group_by(Element) %>%
  summarise(
    Mean   = mean(Concentration, na.rm = TRUE),
    Median = median(Concentration, na.rm = TRUE),
    LQ     = quantile(Concentration, 0.25, na.rm = TRUE),
    UQ     = quantile(Concentration, 0.75, na.rm = TRUE),
    Min    = min(Concentration, na.rm = TRUE),
    Max    = max(Concentration, na.rm = TRUE),
    .groups = "drop"
  )
kable(summary_table)
```

We can see that all the ingots are primarily composed of Copper (least being 69%), and Zinc (average of 20% by mass). There is a small amount of Lead in each ingot (5.5% avg) and trace amounts of iron (0.5% avg).

The Copper content appears distributed symmetrically with a small right skew - seeming to vaguely follow a Gaussian curve. The Zinc content also seems symmetrically distributed, with the exception of an outlier with 28% Zinc content. As noted it appears that the composition ratio of these two elements is controlled.

Iron levels in this data appear to be randomly distributed, and suggest that it is an unintentional addition to the alloy with other ore or slag.

Lead appears to be largely consistent (IQR between 4.7% and 6.5%), and as noted in the paper (Section 3.1) would have been added to lower the melting point of the alloy and allow for easier casting. There is an outlier with 1.05% Lead content (S25).

```{r}
# Boxplots
ggplot(main.elements.long, aes(x=Element)) + 
  geom_boxplot(aes(col=Element), notch = TRUE) +
  facet_grid(~ Element) +
  theme(axis.text.x = element_text(size=7, angle=90, hjust=1), 
        legend.position = 'none')
```

```{r}
# Correlation plot
corrplot(cor(main.elements[,-1]), method='circle', type='upper', 
         title = "Correlation of main elements")
```

Unsurprisingly, there is a negative correlation between copper content and all other elements - seeing as this is based off a 100% composition. Zinc does have mild positive correlations with both lead and iron. Some research shows that the main zinc ore (zinc sulfide) is often copresent with lead and iron sulfides as well - it is plausible that some lead and iron is also introduced to the alloy along with zinc accidentally.

(<https://en.wikipedia.org/wiki/Zinc#Production>, Production/Mining and Processing/ para 3)

```{r}
# Pairs plot
ggpairs(main.elements[,-1], columns = 1:4, 
        upper=list(continuous="density", combo="box_no_facet", 
                   ggplot2::aes(col=surprise, alpha=.5), title="Pairs of main elements"))

```

No clear patterns

```{r}
# Mahalanobis Distances
est.mu <- colMeans(main.elements[,-1])
est.covar <- var(main.elements[,-1])

dM <- mahalanobis(main.elements[,-1], est.mu, est.covar)
upper.quantiles <- qchisq(c(.9, .95, .99), df=4)
density.at.quantiles <- dchisq(x=upper.quantiles, df=4)
cut.points <- data.frame(upper.quantiles, density.at.quantiles)

ggplot(data.frame(dM), aes(x=dM)) +
  geom_histogram(aes(y=after_stat(density)), bins=nclass.FD(dM),
  fill="white", col="black") +
  stat_function(fun=dchisq, args = list(df=4),
  col="blue", linewidth=2, alpha=.7, xlim=c(0,65)) +
  geom_segment(data=cut.points,
  aes(x=upper.quantiles, xend=upper.quantiles,
  y=rep(0,3), yend=density.at.quantiles),
  col="red", linewidth=1)

upper.quantiles

x <- sum(dM > upper.quantiles[3])
x
```

We see here that there are 2 points that are above the 95% quantile so classed as surprising (and one as very surprising).

```{r}
PCA.main.elements <- prcomp(main.elements[,-1], center = TRUE, scale = TRUE)
summary(PCA.main.elements)
# plot(PCA.main.elements, type='lines')
PCA.main.elements$sdev
PCA.main.elements$center
head(PCA.main.elements)

variance.PCA.me <- PCA.main.elements$sdev^2 / sum(PCA.main.elements$sdev^2)
qplot(c(1:4), variance.PCA.me) +
  geom_line() +
  geom_point(size = 4) +
  xlab("Principal Component") +
  ylab("Variance Explained") +
  ggtitle("Scree Plot") +
  ylim(0,1)

ggbiplot(PCA.main.elements, obs.scale = 1, var.scale = 1, alpha = 0.1, 
         labels = main.elements$Sample)
```

We can see that from an initial PCA,
